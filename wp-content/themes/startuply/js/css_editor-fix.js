/* =========================================================
 * css_editor.js v1.0.1
 * =========================================================
 * Copyright 2014 Wpbakery
 *
 * Shortcodes css editor for edit form backbone/underscore version
 * ========================================================= */
// Safety first
/** global window.i18nLocale */
if(_.isUndefined(window.vc))var vc={atts:{}};!function(e){var t,i=ajaxurl.replace(/admin\-ajax\.php/,"images/wpspin_light.gif"),a={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g};wp.media.controller.VcCssSingleImage=wp.media.controller.VcSingleImage.extend({setCssEditor:function(e){return e&&(this._css_editor=e),this},updateSelection:function(){var e,t=this.get("selection"),i=this._css_editor.getBackgroundImage();i&&(e=wp.media.model.Attachment.get(i),e.fetch()),t.reset(e?[e]:[])}});var s;s=vc.CssEditor=Backbone.View.extend({attrs:{},layouts:["margin","border-width","padding"],positions:["top","right","bottom","left"],$field:!1,simplify:!1,$simplify:!1,events:{"click .icon-remove":"removeImage","click .vc_add-image":"addBackgroundImage","change .vc_simplify":"changeSimplify"},initialize:function(){_.bindAll(this,"setSimplify")},render:function(e){return this.attrs={},this.$simplify=this.$el.find(".vc_simplify"),_.isString(e)&&this.parse(e),this.$el.find('input[name="background_color"]').closest(".color-group").prev().remove(),this.$el.find('input[name="background_color"]').closest(".color-group").remove(),this.$el.find(".vc_background-image").remove(),this.$el.find(".vc_background-style").remove(),this},parse:function(e){var t=e.split(/\s*(\.[^\{]+)\s*\{\s*([^\}]+)\s*\}\s*/g);t[2]&&this.parseAtts(t[2].replace(/\s+!important/g,""))},addBackgroundImage:function(e){return e.preventDefault(),this.image_media?this.image_media.open("vc_editor"):(this.image_media=wp.media({state:"vc_single-image",states:[(new wp.media.controller.VcCssSingleImage).setCssEditor(this)]}),this.image_media.on("toolbar:create:vc_single-image",function(e){this.createSelectToolbar(e,{text:window.i18nLocale.set_image})},this.image_media),this.image_media.state("vc_single-image").on("select",this.setBgImage),void this.image_media.open("vc_editor"))},setBgImage:function(){var t=this.get("selection").single();t&&this._css_editor.$el.find(".vc_background-image .vc_image").html(_.template(e("#vc_css-editor-image-block").html(),t.attributes,_.extend({variable:"img"},a)))},setCurrentBgImage:function(t){var s,n=/([^\?]+)(\?id=\d+){0,1}/,r="",o="";t.match(/^\d+$/)?(this.$el.find(".vc_background-image .vc_image").html(_.template(e("#vc_css-editor-image-block").html(),{url:i,id:t,css_class:"vc_preview"},_.extend({variable:"img"},a))),e.ajax({type:"POST",url:window.ajaxurl,data:{action:"wpb_single_image_src",content:t,size:"full"},dataType:"html",context:this}).done(function(e){this.$el.find(".vc_ce-image").attr("src",e+"?id="+t).removeClass("vc_preview")})):t.match(n)&&(s=t.split(n),r=s[1],s[2]&&(o=s[2].replace(/[^\d]+/,"")),this.$el.find(".vc_background-image .vc_image").html(_.template(e("#vc_css-editor-image-block").html(),{url:r,id:o},_.extend({variable:"img"},a))))},changeSimplify:function(){var e=_.debounce(this.setSimplify,100);e&&e()},setSimplify:function(){this.simplifiedMode(this.$simplify.is(":checked"))},simplifiedMode:function(t){t?(this.simplify=!0,this.$el.addClass("vc_simplified")):(this.simplify=!1,this.$el.removeClass("vc_simplified"),_.each(this.layouts,function(t){"border-width"===t&&(t="border");var i=e("[data-attribute="+t+"].vc_top");this.$el.find("[data-attribute="+t+"]:not(.vc_top)").val(i.val())},this))},removeImage:function(t){var i=e(t.currentTarget);t.preventDefault(),i.parent().remove()},getBackgroundImage:function(){return this.$el.find(".vc_ce-image").data("imageId")},parseAtts:function(e){var t,i,a;t=/(\d+\S*)\s+(\w+)\s+([\d\w#\(,]+)/,i=/^([^\s]+)\s+url\(([^\)]+)\)([\d\w]+\s+[\d\w]+)?$/,a=!1,_.map(e.split(";"),function(e){var s,n,r,o=e.split(/:\s/),c=o[1]||"",d=o[0]||"";c&&(c=c.trim()),d.match(new RegExp("^("+this.layouts.join("|").replace("-","\\-")+")$"))&&c?(s=c.split(/\s+/g),1==s.length?s=[s[0],s[0],s[0],s[0]]:2===s.length?(s[2]=s[0],s[3]=s[1]):3===s.length&&(s[3]=s[1]),_.each(this.positions,function(e,t){this.$el.find("[data-name="+d+"-"+e+"]").val(s[t])},this)):"background-size"===d?(a=c,this.$el.find("[name=background_style]").val(c)):"background-repeat"!==d||a?"background-image"===d?this.setCurrentBgImage(c.replace(/url\(([^\)]+)\)/,"$1")):"background"===d&&c?(r=c.split(i),r[1]&&this.$el.find("[name="+d+"_color]").val(r[1]),r[2]&&this.setCurrentBgImage(r[2])):"border"==d&&c&&c.match(t)?(n=c.split(t),s=[n[1],n[1],n[1],n[1]],_.each(this.positions,function(e,t){this.$el.find("[name="+d+"_"+e+"_width]").val(s[t])},this),this.$el.find("[name=border_style]").val(n[2]),this.$el.find("[name=border_color]").val(n[3]).trigger("change")):-1!=d.indexOf("border")&&c?-1!=d.indexOf("style")?this.$el.find("[name=border_style]").val(c):-1!=d.indexOf("color")?this.$el.find("[name=border_color]").val(c).trigger("change"):d.match(/^[\w\-\d]+$/)&&this.$el.find("[name="+d.replace(/\-+/g,"_")+"]").val(c):d.match(/^[\w\-\d]+$/)&&c&&this.$el.find("[name="+d.replace(/\-+/g,"_")+"]").val(c):this.$el.find("[name=background_style]").val(c)},this)},save:function(){var e="";return this.attrs={},_.each(this.layouts,function(e){this.getFields(e)},this),this.getBackground(),this.getBorder(),_.isEmpty(this.attrs)||(e=".vc_custom_"+ +new Date+"{"+_.reduce(this.attrs,function(e,t,i){return t?e+i+": "+t+" !important;":e},"",this)+"}"),e&&vc.frame_window&&vc.frame_window.vc_iframe.setCustomShortcodeCss(e),e},getBackgroundImageSrc:function(){},getBackgroundColor:function(){},getBackgroundStyle:function(){},getBackground:function(){},getBorder:function(){var e=this.$el.find("[name=border_style]").val(),t=this.$el.find("[name=border_color]").val(),i=["left","right","top","bottom"];e&&t&&this.attrs["border-width"]&&this.attrs["border-width"].match(/^\d+\S+$/)?(this.attrs.border=this.attrs["border-width"]+" "+e+" "+t,this.attrs["border-width"]=void 0):_.each(i,function(i){this.attrs["border-"+i+"-width"]&&(t&&(this.attrs["border-"+i+"-color"]=t),e&&(this.attrs["border-"+i+"-style"]=e))},this)},getFields:function(e){var t=[];return this.simplify?this.getSimplifiedField(e):(_.each(this.positions,function(i){var a=this.$el.find("[data-name="+e+"-"+i+"]").val().replace(/\s+/,"");a.match(/^\d*(\.\d?){0,1}(%|in|cm|mm|em|rem|ex|pt|pc|px|vw|vh|vmin|vmax)$/)||(a=isNaN(parseFloat(a))?"":""+parseFloat(a)+"px"),a.length&&t.push({name:i,val:a})},this),void _.each(t,function(t){var i="border-width"==e?"border-"+t.name+"-width":e+"-"+t.name;this.attrs[i]=t.val},this))},getSimplifiedField:function(e){var t="top",i=this.$el.find("[data-name="+e+"-"+t+"]").val().replace(/\s+/,"");i.match(/^\d*(\.\d?){0,1}(%|in|cm|mm|em|rem|ex|pt|pc|px|vw|vh|vmin|vmax)$/)||(i=isNaN(parseFloat(i))?"":""+parseFloat(i)+"px"),i.length&&(this.attrs[e]=i)}}),vc.atts.css_editor={parse:function(e){var i,a,s;return i=this.content().find('input.wpb_vc_param_value[name="'+e.param_name+'"]'),a=i.data("vcFieldManager"),s=a.save(),s&&vc.edit_form_callbacks.push(t),s},init:function(t,i){e("[data-css-editor=true]",this.content()).each(function(){var i=e(this),a=i.find('input.wpb_vc_param_value[name="'+t.param_name+'"]'),r=a.val();r||(r=n()),a.data("vcFieldManager",new s({el:i}).render(r))}),vc.atts.colorpicker.init.call(this,t,i)}};var n=function(){var e={old_bg_color:"background-color",padding:"padding",margin_bottom:"margin-bottom",old_bg_image:"background-image"},t=vc.edit_element_block_view.model.get("params"),i=_.reduce(e,function(e,i,a){var s=t[a];return _.isUndefined(s)||!s.length?e:("old_bg_image"===a&&(s="url("+s+")"),e+i+": "+s+";")},"",this);return i?".tmp_class{"+i+"}":""};t=function(){this.params=_.omit(this.params,"old_bg_color","padding","margin_bottom","old_bg_image")}}(window.jQuery);